---
title: "ROL model fitting"
output: html_document
author: "Kim Roche"
date: "3/13/2020"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Parsing data

The following examples use a subset of the full host lists that include just individuals Dudu, Omo, and Vet (DUD, OMO, VET). The first steps include reading in the phyloseq object containing the data for these hosts and (1) agglomerating taxa (using `phyloseq::tax_glom`) to the desired taxonomic level, (2) subsetted to hosts with at least a minimum number of samples (currently 40), then (3) filtering low abundance taxa into a low resolution group designated by the label "Other." This is done by the function `load_data` which stores the results of the agglomeration and filtering in the input directory in files named `glom_data_*.rds` and `filtered_*.rds` respectively.

Note: Choosing `tax_level=ASV` performs all steps *but* agglomeration.

The parameters `count_threshold` and `sample_threshold` together specify the filtering conditions: taxa with *fewer than* this number of counts in *fewer than* this proportion of *each host's* samples will be shunted into the "Other" category. The idea here is to accumulate a set of taxa that are persistently present in all hosts. Rare or host-specific taxa will be excluded from dynamics analyses!

```{r}
library(ROL)

tax_level <- "family"
data <- load_data(tax_level=tax_level, replicates=TRUE, count_threshold=5, sample_threshold=0.2)
```

## Fitting the stray::basset model for each individual

First let's estimate parameter choices for the reference (ALR) taxon to use (optionally) and the scale of the squared exponential (autocorrelative) and periodic (seasonal) kernels:

```{r}
params <- formalize_parameters(data)
```

Fit a full and MAP version of the stray::basset model to all individuals in the data set:

```{r}
suppressMessages(library(phyloseq))

hosts <- unique(sample_data(data)$sname)

for(host in hosts) {
  # fit full model
  fit_GP(host=host, tax_level=tax_level, SE_sigma=params$SE_variance, PER_sigma=params$PER_variance,
         SE_days_to_baseline=90, alr_ref=params$alr_ref, n_samples=10)
  # fit MAP model
  fit_GP(host=host, tax_level=tax_level, SE_sigma=params$SE_variance, PER_sigma=params$PER_variance,
         SE_days_to_baseline=90, alr_ref=params$alr_ref, MAP=TRUE)
  
}
```

Let's sanity check the model fits by looking at the posterior predictive distribution of the denoised log relative abundances

```{r}
plot_posterior_predictive(host="OMO", tax_level=tax_level, predict_coords=c(1,2), show_plot=TRUE)
```

And let's take a look at the estimated (MAP) covariance for one host (OMO).

```{r}
plot_MAP_covariance(host="OMO", tax_level=tax_level, show_plot=TRUE)
```