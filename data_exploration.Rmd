---
title: "ROL data exploration"
output: html_document
author: "Kim Roche"
date: "3/13/2020"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Parsing data

The following examples use a subset of the full host lists that include just individuals Dudu, Omo, and Vet (DUD, OMO, VET). The first steps include reading in the phyloseq object containing the data for these hosts and (1) agglomerating taxa (using `phyloseq::tax_glom`) to the desired taxonomic level, (2) subsetted to hosts with at least a minimum number of samples (currently 40), then (3) filtering low abundance taxa into a low resolution group designated by the label "Other." This is done by the function `load_data` which stores the results of the agglomeration and filtering in the input directory in files named `glom_data_*.rds` and `filtered_*.rds` respectively.

Note: Choosing `tax_level=ASV` performs all steps *but* agglomeration.

The parameters `count_threshold` and `sample_threshold` together specify the filtering conditions: taxa with *fewer than* this number of counts in *fewer than* this proportion of *each host's* samples will be shunted into the "Other" category. The idea here is to accumulate a set of taxa that are persistently present in all hosts. Rare or host-specific taxa will be excluded from dynamics analyses!

```{r}
library(ROL)

tax_level <- "family"
data <- load_data(tax_level=tax_level, replicates=TRUE, count_threshold=5, sample_threshold=0.2)
```

## Exploratory data analysis

We can visualize an single host's time series using barplots:

```{r}
plot_timecourse(data, host="OMO", gapped=FALSE, legend=TRUE, show_plot=TRUE)
```

If we want to visualize the approximate spacing between observations we can use `gapped=TRUE`:

```{r}
plot_timecourse(data, host="OMO", gapped=TRUE, legend=FALSE, show_plot=TRUE)
```

We can render autocorrelation plots either with or without error approximation. To render mean autocorrelation only (fast) use:

```{r}
lagged_ac <- calc_autocorrelation(data, lag_units="weeks", lag_max=52, use_lr="ilr", alr_ref=NULL, resample=FALSE)
plot_mean_autocorrelation(lagged_ac, show_plot=TRUE)
```

To estimate uncertainty via subsampling (slow) use:

```{r}
lagged_ac <- calc_autocorrelation(data, lag_units="weeks", lag_max=52, use_lr="ilr", alr_ref=NULL, resample=TRUE, resample_rate=0.2)
plot_bounded_autocorrelation(lagged_ac, show_plot=TRUE)
```

Using `resample_rate=0.2` resamples 20% of the dataset 100 times to calculate 100 estimates of autocorrelation, which are plotted as an interval around the mean estimate.

Note: the small sample size makes these estimates super noisy.


